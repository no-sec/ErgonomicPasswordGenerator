
<html>
<header>
	<title>Ergonomic Password Generator</title>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
</header>
<body>
	<button type="button" onclick="generatePassword(10)">Klick me</button>
	<label id="password">Test</label>
</body>
<script type="text/javascript">
	
		var label = document.getElementById('password');
		var ept = true;
		/* the used chars split up by category */
		var lettersSmall = "abcdefghijklmnopqrstuvwxyz";
		var lettersBig = "ABCDEFGHIJKLMNOPQRSTUVWXYZ";
		var numbers = "0123456789";
		var specialChars = "^+#-.<,ß";
		var specialCharsShift = "°!\"§$%&/()=?*';:_>";
		var specialCharsThirdDim = "@{[]}\\~|";
	
		/* the used chars split up by hand */
		var fingerCharDict = {
			l0: "^12\"qay<°!QA>Y|@",
			l1: "3wsx§WSX",
			l2: "4edc$EDC",
			l3: "56rtfgvb%&RTFGVB",
			r3: "78zuhjnm/(ZUHJNM{[",
			r2: "9ik,)IK;]",
			r1: "0ol.=OL:}",
			r0: "ßp-+#?P_*'~\\"
		};
	
		var allChars = lettersSmall + lettersBig + numbers + specialChars + specialCharsShift + specialCharsThirdDim;
				
		function generateErgonomicPassword(length) {
			/* The state of the hand 
			0 = k, 1 = r, 2 = m, 3 = z */
			var handState = {
				isLeftHand: getRandomNumberInRange(2),
				selectedFinger: getRandomNumberInRange(4)
			}
			password = '';
			for (var r = 0; r < length; r++) {
				//Update hand state
				if(getTrue(80)) {
					//Change hand and select new finger
					handState.isLeftHand = !handState.isLeftHand;
					handState.selectedFinger = selectValue([0,1,2,3], [9, 14, 25, 52]);
				} else {
					if (getTrue(70)) {
						//Select a finger different from the current one
						var tmpValues = [0, 1, 2, 3];
						var tmpProb = [9, 14, 25, 52];
						var index = tmpValues.indexOf(handState.selectedFinger) 
						tmpValues.splice(index, 1);
						tmpProb.splice(index, 1);
						handState.selectedFinger = selectValue(tmpValues, tmpProb);
					}
				}
				
				//Get the chars for the selected finger
				var fingerChars = handState.isLeftHand ? "l" : "r";
				fingerChars = fingerCharDict[fingerChars + handState.selectedFinger];
				
				//Select the alphabet we are working on
				var selectedChars = null
				if(!getTrue(50)) {
					selectedChars = selectValue(['s', numbers, lettersBig], [3, 4, 3]);
					if (selectedChars == 's') {
						if (getTrue(30)) {
							selectedChars = specialCharsThirdDim;
						} else {
							selectedChars = specialCharsShift;
						}
					}
				} else {
					selectedChars = lettersSmall + specialChars;
				}
				
				//Get the intersection of fingerChars and selectedChars
				var resultChars = [];
				for(var i = 0; i < fingerChars.length; i++) {
					for(var k = 0; k < selectedChars.length; k++) {
						if (fingerChars[i] == selectedChars[k]) {
							resultChars.push(fingerChars[i]);
						}
					}
				}
			
				if (resultChars.length > 0) {
					var index = getRandomNumberInRange(resultChars.length);
					password += resultChars[index];
				} else {
					r -= 1;
				}
			}
			return password;
		}
		
		//for (i = 0; i < 1000; ++i) {
		//	console.log(ept(8));
		//}
		
		/* Returns the specified number of random 32 bit
		integers as array. Not more than 16384*/
		function getRandomNumbers(number) {
			var array = new Uint32Array(number);
			window.crypto.getRandomValues(array);
			return array;
		}
		
		/* Returns a single random 32 bit integer */
		function getRandomNumber() {
			return getRandomNumbers(1)[0];
		}
	
		/* Get a random number in the range 0 to (end - 1) */
		function getRandomNumberInRange(end) {
			return getRandomNumber() % end;
		}
		
		/* Returns true with a probability of the specified probability */
		function getTrue(probability) {
			return selectValue([true, false], [probability, 100 - probability]);
		}
		
		/* Selects a random value from values based on the probabilities provided */
		function selectValue(values, probabilities) {
			if (values.length != probabilities.length)
				return -1;
			
			var fullRange = 0;
			for (var i = 0; i < values.length; i++) {
				fullRange += probabilities[i];
			}
			
			var rnd = getRandomNumberInRange(fullRange) + 1;
			for (var i = 0; i < values.length; i++) {
				rnd -= probabilities[i];
				if (rnd <= 0)
					return values[i];
			}
			
			console.log("Error: It failed to decide a value, this should never happen");
			return -1;
		}
		
		function calculateEntropy(chars) {
			return chars.length^password_length;
		}
		
		function generatePassword(length) {
			var password;
			if (ept)
				password = generateErgonomicPassword(length);
			else
				password = generateRandomPassword(length);
			label.innerText = password;
		}
		
		function generateRandomPassword(length) {
			var chars = allChars;
			var password = '';
			for (var i = 0; i < length; i++) {
				var index = getRandomNumber() % chars.length;
				password += chars.charAt(index);
			}
			return password;
		}
		
		/* 
		console.log(decider([1,2,3,4], [2,3,3,2]));
		var c1 = 0, c2 = 0, c3 = 0, c4 = 0; 
		var iterations = 1000000;
		for (var i = 0; i < iterations; ++i) {
			var tmp = decider([1,2,3,4], [2,3,3,2]);
			
			switch (tmp) {
				case 1:
					c1++; break;
				case 2:
					c2++; break;
				case 3:
					c3++; break;
				case 4:
					c4++; break;
			}
			
		}
		
		console.log(c1 / iterations);
		console.log(c2 / iterations);
		console.log(c3 / iterations);
		console.log(c4 / iterations);
		*/
		
</script>
</html>